#!/bin/sh
# 

module_id() {
   cat /proc/hal/model
}

export LOGNAME=root
export HOME=/$LOGNAME
#export QWS_DISPLAY=Transformed:Rot270:0
export QTDIR=/opt/QtPalmtop
export OPIEDIR=/opt/QtPalmtop
export QPEDIR=/opt/QtPalmtop
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$OPIEDIR/lib
export PATH=$PATH:$OPIEDIR/bin

#this sets the iPaqs powerbutton to mapable
echo 1 > /proc/sys/ts/suspend_button_mode

if [ ! -x $OPIEDIR/bin/qpe ] ; then exit 0 ; fi

$OPIEDIR/bin/opie-reorgfiles

. /etc/profile

killproc() {
        pid=`/bin/ps -e | /bin/sed -n -e '/\<'$1'\>/ s/^ *\([0-9][0-9]*\).*/\1/p'`
        [ "$pid" != "" ] && kill $pid
}

case $1 in
'start')
	echo "Starting Opie..."

	cd $HOME

	rm -f /etc/rc2.d/S99x # Can't have both running!

	 case `module_id` in 
        "3100" ) export QWS_DISPLAY=Transformed:Rot90:0 ;;
        "3600" ) export QWS_DISPLAY=Transformed:Rot270:0 ;;
        "3700" ) export QWS_DISPLAY=Transformed:Rot270:0 ;;
        "3800" ) export QWS_DISPLAY=Transformed:Rot90:0 ;;
        *) echo "Unknown processor type -`module_id`-!" ;;
   	 esac
	
	if [ -x $OPIEDIR/bin/opie-login ]; then
		$OPIEDIR/bin/opie-login 2>/dev/null >/dev/null &
	else
		$OPIEDIR/bin/qpe 2>/dev/null >/dev/null &
	fi

	;;
'stop')
        echo "Killing Opie..."
        if [ -f /var/run/opie.pid ]; then
        	kill -TERM `cat /var/run/opie.pid`
        else
        	killproc qpe
        fi
        killproc opie-login
        ;;
*)
        echo "usage: $0 { start | stop }"
        ;;
esac

